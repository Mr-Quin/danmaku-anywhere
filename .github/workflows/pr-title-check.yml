name: PR Title Check

on:
  pull_request:
    types:
      - opened
      - edited
      - reopened
      - synchronize
      - ready_for_review

jobs:
  check-title:
    name: Validate PR title format
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Validate title
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = context.payload.pull_request?.title ?? '';
            const pattern = /^\((extension|app|proxy|chore|docs)\)\s.+\s\[DA-\d+\]$/;

            if (!pattern.test(title)) {
              const errorMessage =
                `Invalid PR title: "${title}".\n\nExpected: (TYPE) description [TASK-ID]\n- TYPE: one of extension, app, proxy, chore, docs\n- TASK-ID: DA-<number> (e.g., DA-123)`;

              const commentLines = [
                '## ⚠️ PR Title Format Issue',
                '',
                "The PR title doesn't match the required format.",
                '',
                '**Current title:**',
                '```',
                `${title}`,
                '```',
                '',
                '**Expected format:**',
                '```',
                '(TYPE) description [TASK-ID]',
                '```',
                '',
                '**Details:**',
                '- **TYPE**: Must be one of: `extension`, `app`, `proxy`, `chore`, `docs`',
                '- **description**: A brief description of the changes',
                '- **TASK-ID**: Must match the pattern `DA-<number>` (e.g., `DA-123`)',
                '',
                '**Example:**',
                '```',
                '(app) Add user authentication [DA-456]',
                '```',
                '',
                'Please update your PR title to match this format.'
              ];

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: commentLines.join('\n')
              });

              core.setFailed(errorMessage);
            } else {
              core.info(`PR title is valid: ${title}`);
            }
